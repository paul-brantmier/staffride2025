<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Ride Viewer</title>

  <!-- Reduce browser caching of viewer shell -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root { --border:#e5e5e5; --muted:rgba(0,0,0,.65); }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .bar {
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--border);
    }
    .left { display:flex; gap:12px; align-items:baseline; flex-wrap:wrap; }
    .title { font-weight:600; }
    .meta { font-size:12px; color:var(--muted); }
    .btn {
      padding:7px 10px; border:1px solid #ccc; border-radius:10px; background:#fff; cursor:pointer;
    }
    .wrap { height: calc(100vh - 52px); }
    iframe {
      width:100%; height:100%; border:0; display:block; background:#fff;
    }
    .err {
      padding:16px; color:#b00; font-size:14px;
    }
  </style>
</head>

<body>
  <div class="bar">
    <div class="left">
      <div class="title">Staff Ride Viewer</div>
      <div id="status" class="meta">Loading…</div>
    </div>
    <div class="right">
      <button id="refreshBtn" class="btn" type="button">Refresh</button>
      <a class="meta" href="editor.html">Open editor</a>
    </div>
  </div>

  <div class="wrap">
    <iframe id="contentFrame"
      sandbox="allow-same-origin allow-forms allow-popups allow-modals allow-scripts"
      referrerpolicy="no-referrer">
    </iframe>
  </div>

  <script src="./sheets_api.js"></script>
  <script>
    /**
     * Set this to your deployed Google Apps Script Web App URL.
     * Example:
     * const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycb.../exec";
     */
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbxNPJGn-2Rxm7cx1two7aBQrvM0atcytraXdqnnm44a8aKDf9-7rdR2LHU3XxdmWPU/exec";

    // Optional: identify what page/content to load (lets one sheet store multiple pages)
    const CONTENT_KEY = "staffride_main";

    const statusEl = document.getElementById("status");
    const frame = document.getElementById("contentFrame");
    const refreshBtn = document.getElementById("refreshBtn");

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function setFrameHtml(html) {
      // force a clean re-render
      frame.srcdoc = "";
      requestAnimationFrame(() => {
        frame.srcdoc = html || "<p class='err'>No content returned.</p>";
      });
    }

    async function loadLatest() {
      if (!SHEETS_API_URL || SHEETS_API_URL.includes("PASTE_YOUR")) {
        setStatus("Viewer not configured: add your Apps Script URL in viewer.html");
        setFrameHtml(`<div class="err">
          Missing Apps Script URL.<br>
          Open viewer.html and set <code>SHEETS_API_URL</code>.
        </div>`);
        return;
      }

      try {
        setStatus("Fetching latest content…");
        const res = await SheetsAPI.getContent({
          apiUrl: SHEETS_API_URL,
          key: CONTENT_KEY,
          // cache buster so you always get newest
          cacheBust: true
        });

        if (!res.ok) {
          setStatus("Failed to load content.");
          setFrameHtml(`<div class="err">
            Failed to load content.<br>
            Status: ${escapeHtml(String(res.status))}<br>
            Message: ${escapeHtml(res.error || "Unknown error")}
          </div>`);
          return;
        }

        // res.html should be a full HTML doc or a fragment. We accept either.
        const htmlDoc = SheetsAPI.wrapIfFragment(res.html, {
          title: "Staff Ride",
          includeBaseStyles: true
        });

        setFrameHtml(htmlDoc);

        const updated = res.updated_at ? `Updated: ${res.updated_at}` : "Updated: (timestamp unavailable)";
        setStatus(`${updated} • Source: Google Sheets`);
      } catch (err) {
        console.error(err);
        setStatus("Error loading content.");
        setFrameHtml(`<div class="err">
          Error loading content. Check console.<br>
          ${escapeHtml(String(err))}
        </div>`);
      }
    }

    refreshBtn.addEventListener("click", loadLatest);

    // Auto-refresh on load
    loadLatest();

    // Optional: auto-refresh every N minutes
    // setInterval(loadLatest, 60_000); // every 60s (uncomment if you want)
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }
  </script>
</body>
</html>
