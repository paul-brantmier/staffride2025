<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Ride Editor</title>
  <style>
    :root {
      --border: #ddd;
      --muted: rgba(0,0,0,.70);
      --bg: #fff;
      --panel: #fafafa;
      --btn-border: #cfcfcf;
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 16px;
      background: var(--bg);
    }

    header {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    header .left {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: baseline;
    }

    a { text-decoration: none; }

    .hint { color: var(--muted); font-size: 13px; }
    .ok { color: #0a7; }
    .warn { color: #b60; }
    .err { color: #b00; }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0;
    }

    button {
      padding: 8px 12px;
      border: 1px solid var(--btn-border);
      border-radius: 12px;
      background: var(--bg);
      cursor: pointer;
    }
    button:active { transform: translateY(1px); }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      align-items: start;
    }

    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 12px;
    }

    .card h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    textarea {
      width: 100%;
      height: 44vh;
      font-family: var(--mono);
      font-size: 13px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-sizing: border-box;
      background: var(--bg);
      resize: vertical;
    }

    iframe {
      width: 100%;
      height: 44vh;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      display: block;
    }

    .pasteZone {
      min-height: 140px;
      border: 1px dashed #bbb;
      border-radius: var(--radius);
      padding: 12px;
      background: var(--bg);
      overflow: auto;
    }

    .pasteZone:focus {
      outline: 2px solid rgba(0,120,255,.25);
      outline-offset: 2px;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--bg);
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <a href="staffride.html">Back to viewer</a>
      <span class="pill">Editor</span>
      <span id="status" class="hint">Ready.</span>
    </div>
    <div class="hint">Saves to this browser via localStorage (not to GitHub).</div>
  </header>

  <div class="row">
    <button id="loadBtn" type="button">Load saved</button>
    <button id="saveBtn" type="button">Save</button>
    <button id="previewBtn" type="button">Preview</button>
    <button id="clearBtn" type="button">Clear saved</button>
    <button id="exportBtn" type="button">Export HTML</button>

    <button id="importDocxBtn" type="button">Import Word (.docx)</button>
    <input id="docxFileInput" type="file" accept=".docx" style="display:none" />
  </div>

  <div class="grid">
    <div class="card">
      <h2>HTML editor</h2>
      <div class="hint" style="margin-bottom: 10px;">
        Paste a full HTML document or a fragment. If it is a fragment, it will be wrapped into a full page when saving.
      </div>
      <textarea id="htmlBox" placeholder="Paste full HTML here (including <html>...</html>) or just a fragment."></textarea>
      <div class="small" style="margin-top: 8px;">
        Tip: if your viewer uses a marker like &lt;!--TABLE_HERE--&gt;, you can paste an Excel table below and insert it cleanly.
      </div>
    </div>

    <div class="card">
      <h2>Live preview</h2>
      <div class="hint" style="margin-bottom: 10px;">This previews what will display in staffride.html.</div>
      <iframe id="previewFrame" sandbox="allow-same-origin allow-forms allow-popups allow-modals allow-scripts"></iframe>
    </div>
  </div>

  <div class="card" style="margin-top: 14px;">
    <h2>Paste Excel table</h2>
    <div class="hint" style="margin-bottom: 10px;">
      Copy cells in Excel, click the box, then paste. This keeps row/column structure. Then insert into your page.
    </div>

    <div class="row">
      <span class="hint">Insert location:</span>
      <label class="hint"><input type="radio" name="insertMode" value="replace_marker" checked /> replace marker</label>
      <label class="hint"><input type="radio" name="insertMode" value="append_end" /> append to end</label>
      <span class="hint" style="margin-left: 6px;">Marker string:</span>
      <input id="markerInput" type="text" value="<!--TABLE_HERE-->" style="flex:1; min-width: 220px; padding:8px 10px; border:1px solid #ddd; border-radius:12px;" />
    </div>

    <div id="pasteZone" class="pasteZone" contenteditable="true">Paste table here…</div>

    <div class="row" style="margin-top: 10px;">
      <button id="insertTableBtn" type="button">Insert table into editor</button>
      <button id="saveTableBtn" type="button">Insert and save</button>
      <span class="hint" id="tableStatus"></span>
    </div>
  </div>

  <!-- DOCX converter (client-side) -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <script>
    const STORAGE_KEY = "staffride_html";

    const box = document.getElementById("htmlBox");
    const frame = document.getElementById("previewFrame");
    const statusEl = document.getElementById("status");

    const pasteZone = document.getElementById("pasteZone");
    const insertTableBtn = document.getElementById("insertTableBtn");
    const saveTableBtn = document.getElementById("saveTableBtn");
    const tableStatus = document.getElementById("tableStatus");

    const markerInput = document.getElementById("markerInput");

    const importDocxBtn = document.getElementById("importDocxBtn");
    const docxFileInput = document.getElementById("docxFileInput");

    function setStatus(msg, kind = "hint") {
      statusEl.textContent = msg;
      statusEl.className = kind;
    }

    function setTableStatus(msg) {
      tableStatus.textContent = msg || "";
    }

    function wrapIfFragment(input) {
      const s = (input || "").trim();
      const looksFullDoc = /<html[\s>]/i.test(s) || /<!doctype html>/i.test(s);
      if (looksFullDoc) return s;

      return `<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Ride 2025</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.45; }
    h1,h2,h3,h4 { margin: 0.9em 0 0.4em; }
    p { margin: 0.5em 0; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px 10px; vertical-align: top; }
    ul, ol { padding-left: 1.4em; }
  </style>
</head>
<body>
${s}
</body>
</html>`;
    }

    function setPreviewFromBox() {
      const html = wrapIfFragment(box.value);
      frame.srcdoc = html;
    }

    function getSaved() {
      return localStorage.getItem(STORAGE_KEY) || "";
    }

    function saveHtml(html) {
      localStorage.setItem(STORAGE_KEY, html);
    }

    function getInsertMode() {
      const el = document.querySelector("input[name='insertMode']:checked");
      return el ? el.value : "replace_marker";
    }

    function extractFirstTable(html) {
      const doc = new DOMParser().parseFromString(html, "text/html");
      const table = doc.querySelector("table");
      return table ? table.outerHTML : "";
    }

    function tsvToTable(tsv) {
      const text = (tsv || "").trim();
      if (!text) return "";

      const rows = text.split(/\r?\n/).map(r => r.split("\t"));

      const esc = (s) => String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");

      let out = '<table>\n<tbody>\n';
      for (const r of rows) {
        out += "  <tr>" + r.map(c => `<td>${esc(c)}</td>`).join("") + "</tr>\n";
      }
      out += "</tbody>\n</table>";
      return out;
    }

    function getTableFromPasteZone() {
      const table = pasteZone.querySelector("table");
      return table ? table.outerHTML : "";
    }

    function insertTableIntoHtml(html, tableHtml) {
      const mode = getInsertMode();
      const marker = markerInput.value || "<!--TABLE_HERE-->";

      if (mode === "replace_marker" && html.includes(marker)) {
        return html.replace(marker, tableHtml);
      }

      // Append near end of body if present
      if (/<\/body>/i.test(html)) {
        return html.replace(/<\/body>/i, `${tableHtml}\n</body>`);
      }

      // If somehow no body tag, append
      return html + "\n" + tableHtml;
    }

    // Main buttons
    document.getElementById("loadBtn").addEventListener("click", () => {
      const saved = getSaved();
      box.value = saved || "";
      if (saved) {
        frame.srcdoc = saved;
        setStatus("Loaded saved content.", "hint ok");
      } else {
        frame.srcdoc = wrapIfFragment("");
        setStatus("No saved content found.", "hint warn");
      }
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
      const html = wrapIfFragment(box.value);
      saveHtml(html);
      frame.srcdoc = html;
      setStatus("Saved. Open staffride.html to view.", "hint ok");
    });

    document.getElementById("previewBtn").addEventListener("click", () => {
      setPreviewFromBox();
      setStatus("Preview updated.", "hint ok");
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      setStatus("Cleared saved content.", "hint warn");
      setTableStatus("");
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const html = wrapIfFragment(box.value);
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "staffride_export.html";
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
      setStatus("Exported as staffride_export.html", "hint ok");
    });

    // Excel paste handling
    pasteZone.addEventListener("paste", (e) => {
      e.preventDefault();

      const html = e.clipboardData.getData("text/html");
      const text = e.clipboardData.getData("text/plain");

      let tableHtml = "";
      if (html) tableHtml = extractFirstTable(html);
      if (!tableHtml && text) tableHtml = tsvToTable(text);

      pasteZone.innerHTML = tableHtml || "<p>(No table detected. Copy actual cells from Excel and try again.)</p>";
      setTableStatus(tableHtml ? "Table detected." : "No table detected.");
    });

    insertTableBtn.addEventListener("click", () => {
      const tableHtml = getTableFromPasteZone();
      if (!tableHtml) {
        setTableStatus("No table in the paste box yet.");
        return;
      }

      const current = wrapIfFragment(box.value);
      const updated = insertTableIntoHtml(current, tableHtml);
      box.value = updated;
      frame.srcdoc = updated;

      setTableStatus("Inserted into editor.");
      setStatus("Preview updated with inserted table.", "hint ok");
    });

    saveTableBtn.addEventListener("click", () => {
      const tableHtml = getTableFromPasteZone();
      if (!tableHtml) {
        setTableStatus("No table in the paste box yet.");
        return;
      }

      const current = wrapIfFragment(box.value);
      const updated = insertTableIntoHtml(current, tableHtml);
      box.value = updated;
      frame.srcdoc = updated;
      saveHtml(updated);

      setTableStatus("Inserted and saved.");
      setStatus("Saved. Open staffride.html to view.", "hint ok");
    });

    // DOCX import (Option 2)
    importDocxBtn.addEventListener("click", () => {
      docxFileInput.value = "";
      docxFileInput.click();
    });

    docxFileInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try {
        setStatus("Importing Word document…", "hint");
        const arrayBuffer = await file.arrayBuffer();

        const result = await mammoth.convertToHtml(
          { arrayBuffer },
          {
            styleMap: [
              "p[style-name='Title'] => h1:fresh",
              "p[style-name='Heading 1'] => h2:fresh",
              "p[style-name='Heading 2'] => h3:fresh",
              "p[style-name='Heading 3'] => h4:fresh"
            ]
          }
        );

        const fragment = result.value || "";
        const messages = result.messages || [];

        const fullHtml = wrapIfFragment(fragment);

        box.value = fullHtml;
        frame.srcdoc = fullHtml;
        saveHtml(fullHtml);

        if (messages.length) {
          setStatus(`Imported and saved. Conversion notes: ${messages.length}.`, "hint warn");
        } else {
          setStatus("Imported and saved successfully.", "hint ok");
        }
      } catch (err) {
        console.error(err);
        setStatus("Import failed. Make sure it is a .docx file and try again.", "hint err");
        alert("DOCX import failed. Make sure the file is .docx (not .doc).");
      }
    });

    // Auto-load on open
    (function init() {
      const saved = getSaved();
      if (saved) {
        box.value = saved;
        frame.srcdoc = saved;
        setStatus("Loaded saved content.", "hint ok");
      } else {
        const blank = wrapIfFragment("");
        box.value = blank;
        frame.srcdoc = blank;
        setStatus("No saved content yet. Edit HTML, then Save.", "hint");
      }
    })();
  </script>
</body>
</html>
